# Esta role formata as partições E aplica as labels.

- name: Formatação da partição root
  community.general.filesystem:
    fstype: "{{ particoes.root.formato }}"
    dev: "{{ particoes.root.device }}"
    force: true
  when: particoes.root.device is defined and particoes.root.device | length > 0

- name: Formatação da partição home
  community.general.filesystem:
    fstype: ext4
    dev: "{{ particoes.home.device }}"
    force: true
  when: particoes.home.device is defined and particoes.home.device | length > 0

- name: Formatação da partição boot
  community.general.filesystem:
    fstype: vfat
    dev: "{{ particoes.boot.device }}"
    force: true
  when: particoes.boot.device is defined and particoes.boot.device | length > 0

- name: Formatação e Label da partição swap
  ansible.builtin.command:
    cmd: "mkswap -L {{ particoes.swap.label }} {{ particoes.swap.device }}"
  when:
    - particoes.swap.device is defined and particoes.swap.device | length > 0
    - particoes.swap.label is defined and particoes.swap.label | length > 0
  changed_when: false

- name: Montar todas as partições (exceto swap)
  ansible.posix.mount:
    path: "/mnt{{ item.mount_point | default('') }}"
    src: "{{ item.device }}"
    fstype: "{{ item.fstype }}"
    state: mounted
  loop:
    - { device: "{{ particoes.root.device }}", fstype: "{{ particoes.root.formato }}", mount_point: '' }
    - { device: "{{ particoes.home.device }}", fstype: 'ext4', mount_point: '/home' }
    - { device: "{{ particoes.boot.device }}", fstype: 'vfat', mount_point: '/boot' }
  when: item.device is defined and item.device | length > 0

- name: Ativar swap por Label
  ansible.builtin.command:
    cmd: "swapon -L {{ particoes.swap.label }}"
  when: particoes.swap.label is defined and particoes.swap.label | length > 0
  changed_when: false